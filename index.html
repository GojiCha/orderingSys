<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goji Cha - Awaken Your Inner Kaiju</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for the Gojira/Retro theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // NEW LOGO COLORS
                        'app-bg': '#E7F2E2', // Keeping a light background but changing accents
                        'logo-gray': '#798799', // Main monster body color (used for background)
                        'logo-purple': '#892F7F', // Dorsal fin color (used for dark text/accents
                        'logo-green': '#81EE4A', // Breath/Matcha highlight color
                        
                        // Mapped old colors to new ones
                        'text-dark': '#892F7F',      // Deep Purple for text/main buttons
                        'card-bg': '#F7F4EB',        // Off-white for cards (Good contrast)
                        'button-main': '#798799',    // Main Gray/Blue for unselected buttons/accents
                        'matcha-highlight': '#85c047', // Vivid Logo Green
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for blocky, retro look */
        .quantity-btn {
            @apply p-2 rounded-none text-lg font-bold transition-colors duration-200 bg-text-dark text-white hover:bg-matcha-highlight focus:outline-none focus:ring-2 focus:ring-matcha-highlight;
            width: 32px;
            height: 32px; 
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #798799; /* Use the logo gray for buttons */
        }
        .quantity-btn:hover {
            background-color: #81EE4A; /* Hover to bright logo green */
            color: #892F7F; /* Change text color to dark purple on hover for visibility */
        }
        .quantity-input {
            @apply text-center bg-card-bg border border-text-dark rounded-none mx-1 text-text-dark font-medium;
            width: 40px;
            height: 32px;
        }
        /* Style for the main confirm button */
        #confirm-button {
             /* Use the main purple accent for the button when enabled */
            background-color: #892F7F; 
            border-color: #798799;
            box-shadow: 4px 4px 0 #798799; /* Shadow in the monster gray color */
        }
        #confirm-button:hover:not(:disabled) {
            background-color: #81EE4A; /* Hover to bright logo green */
            color: #892F7F; /* Text to deep purple */
            box-shadow: 4px 4px 0 #892F7F; /* Shadow to deep purple */
        }
        /* Style for sold out items */
        .sold-out {
            @apply opacity-50 pointer-events-none;
        }
        /* Style for closed shop state */
        .shop-closed {
            /* Dim and disable all interaction on the content when closed */
            opacity: 0.6; 
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-logo-gray min-h-screen p-4 font-sans flex justify-center text-text-dark">

    <div class="w-full max-w-lg bg-card-bg shadow-2xl border-4 border-text-dark rounded-lg overflow-hidden">
        
        <!-- Header - Themed with Poster Art -->
        <!-- NOTE: The image URL is '501873.png'. Ensure this file is uploaded alongside the index.html file. -->
        <header class="h-40 relative bg-cover bg-center border-b-4 border-text-dark" 
                style="background-image: url('501873.png'); background-position: top center;">
            <div class="absolute inset-0 bg-text-dark opacity-0"></div>
            <div class="absolute inset-0"></div>
        </header>

        <div class="p-6 md:p-8">
            
            <!-- Information Banner: BSN Staff Only -->
            <div class="text-center p-3 mb-4 border-4 border-logo-purple bg-logo-green text-logo-purple font-extrabold text-lg rounded-none shadow-md">
                FOR WISMA BSN ONLY
            </div>

            <!-- Full Shop Introduction -->
            <div class="text-center text-base mb-6 border-b border-gray-300 pb-4">
                <h2 class="text-xl font-bold text-text-dark mb-2">üëã Welcome to Goji Cha!</h2>
                
                <p class="text-gray-700 mb-2">
                    Unleash your inner calm with a playful kick ‚Äî where matcha meets attitude.
                    At Goji Cha, we serve handcrafted matcha inspired by Japanese street culture and monster-sized creativity.
                    Whether you crave a smooth latte, a creamy matcha, or something new and bold ‚Äî your next favorite drink is just a tap away.
                </p>
                <p class="font-extrabold text-text-dark mt-3">
                    Stay Zen. Stay Zilla. üíö
                    <span class="block text-sm font-semibold text-gray-700 mt-1">üïò Open daily: 1 PM ‚Äì 2 PM (Lunch Hour)</span>
                </p>
                <!-- Shop Status Display (Customer Facing) -->
                <div id="shop-status-display" class="mt-2 text-xl font-black rounded-sm tracking-wider"></div>
            </div>

            <!-- Admin Toggle (Owner Control) - HIDDEN BY DEFAULT -->
            <div id="admin-controls" class="text-center mb-6 hidden">
                <button onclick="toggleShopStatus()" id="admin-toggle" class="bg-logo-purple text-white p-2 rounded-none text-sm font-bold shadow-md hover:bg-logo-green hover:text-logo-purple">
                    Shop Toggle: <span id="admin-status-text">CLOSED</span>
                </button>
            </div>

            <!-- Content Wrapper - Dimmed and disabled when shop is closed -->
            <div id="order-content" class="transition-opacity duration-300">
                <!-- Menu Section -->
                <main id="menu-container" class="space-y-4 mb-6">
                    <!-- Menu items will be injected here by JavaScript -->
                </main>
                
                <!-- Customer Name Input -->
                <div class="mb-6">
                    <label for="customer-name" class="block text-xl font-bold mb-2 text-text-dark">üë§ Your Name</label>
                    <input type="text" id="customer-name"
                           class="w-full p-3 bg-card-bg border-2 border-text-dark rounded-none focus:ring-matcha-highlight focus:border-matcha-highlight"
                           placeholder="Enter your name for pickup" required>
                </div>
                <!-- End Customer Name Input -->

                <!-- Notes Input Section -->
                <div class="mb-8">
                    <label for="order-notes" class="block text-xl font-bold mb-2 text-text-dark">üìù Add Notes</label>
                    <p class="text-sm text-gray-700 mb-2">E.g., "Less ice" or "I'll be there in 5 mins."</p>
                    <textarea id="order-notes"
                              class="w-full p-3 h-20 bg-card-bg border-2 border-text-dark rounded-none focus:ring-matcha-highlight focus:border-matcha-highlight resize-none"
                              placeholder="Enter specific instructions here..."></textarea>
                </div>
                <!-- End Notes Input -->

                <!-- Order Summary & Confirmation Button -->
                <div class="border-t-4 border-text-dark pt-6">
                    
                    <!-- Pickup Info -->
                    <div class="text-center p-3 mb-4 border-4 border-logo-purple bg-logo-green text-logo-purple font-extrabold text-lg rounded-none shadow-md">
                        <span>üìç Pickup Location:</span>
                        <span class="text-text-dark font-extrabold">LEVEL 17</span>
                    </div>

                    <!-- Total Price -->
                    <div class="flex justify-between items-center text-xl font-bold text-text-dark mb-4">
                        <span>Total Price:</span>
                        <span id="total-price">RM 0.00</span>
                    </div>

                    <button onclick="confirmOrder()"
                        id="confirm-button"
                        disabled
                        class="w-full py-4 text-white font-bold rounded-none border-2 border-text-dark transition-all duration-200 shadow-[4px_4px_0_#2F2E2A]
                               bg-button-main hover:bg-matcha-highlight hover:shadow-[4px_4px_0_#4CAF50] disabled:bg-gray-400 disabled:shadow-[4px_4px_0_#9CA3AF]">
                        Confirm Order
                    </button>
                    
                    <p id="whatsapp-message" class="text-center text-sm text-button-main font-semibold mt-2 hidden">
                        ERROR: Please set the WhatsApp number in the script.
                    </p>
                </div>
            </div>
            <!-- End Content Wrapper -->
        </div>
        
    </div>

    <script>
        // --- CONFIGURATION ---
        // IMPORTANT: Change this to your WhatsApp number, including the country code (e.g., 60123456789 for Malaysia)
        const WHATSAPP_NUMBER = "60126915105"; 
        
        // Global State
        // IMPORTANT: We use a global variable here to avoid issues with customer-side localStorage holding stale status.
        let isShopOpen = false;
        let isOwnerMode = false;
        let itemSoldOutStatus = {}; // { 1: false, 2: true, ... }

        // Define your menu items (no hardcoded isSoldOut property anymore)
        const menu = [
            { id: 1, name: "Matcha Latte", price: 10.00, desc: "Classic iced pure matcha, sweetened/unsweetened, & Oatside milk.", imageUrl: "https://placehold.co/80x80/4CAF50/FFFFFF?text=LATTE" },
            { id: 2, name: "Strawberry Matcha", price: 13.00, desc: "Sweet strawberry puree layered with cool matcha & Oatside milk.", imageUrl: "https://placehold.co/80x80/D32F2F/4CAF50?text=STRAW" },
            { id: 3, name: "Earl Grey Matcha", price: 11.00, desc: "Creamy matcha layered with Earl Grey syrup & Oatside milk.", imageUrl: "https://placehold.co/80x80/A1887F/4CAF50?text=EARL" },
            { id: 4, name: "Lemonade Matcha", price: 12.00, desc: "Tangy fresh sparkling lemonade topped with vibrant matcha.", imageUrl: "https://placehold.co/80x80/FFC107/4CAF50?text=LEMON" },
        ];
        
        // State to track item quantities
        const orderQuantities = {}; 

        // --- SHOP STATUS LOGIC ---

        /**
         * Loads the per-item sold-out status from local storage.
         */
        function loadItemSoldOutStatus() {
            const savedStatus = localStorage.getItem('itemSoldOutStatus');
            if (savedStatus) {
                itemSoldOutStatus = JSON.parse(savedStatus);
            } else {
                // Initialize all to false if nothing saved
                menu.forEach(item => itemSoldOutStatus[item.id] = false);
                localStorage.setItem('itemSoldOutStatus', JSON.stringify(itemSoldOutStatus));
            }
        }

        /**
         * Toggles the sold-out status for a single item.
         */
        function toggleItemSoldOut(itemId) {
            if (!isOwnerMode) return;
            
            // FIX: Ensure the current value is strictly a boolean before negation.
            const currentStatus = !!itemSoldOutStatus[itemId]; 
            itemSoldOutStatus[itemId] = !currentStatus;
            
            // Clear quantity when changing status to prevent the item remaining in the current order
            orderQuantities[itemId] = 0;

            localStorage.setItem('itemSoldOutStatus', JSON.stringify(itemSoldOutStatus));
            renderMenu(); 
            updateSummary(); 
        }

        /**
         * Initializes shop status from local storage and checks for owner access.
         */
        function initializeShopStatus() {
            // 1. Check for Owner Access Parameter (?owner=true)
            const urlParams = new URLSearchParams(window.location.search);
            isOwnerMode = urlParams.get('owner') === 'true';
            
            if (isOwnerMode) {
                document.getElementById('admin-controls').classList.remove('hidden');
            }

            // 2. Load Global Shop Status (FIX: Only read the global status IF the user is the owner)
            // Customers default to the server's state (which we simulate by having the owner manage it)
            if (isOwnerMode) {
                // If owner, load the saved state from their session
                isShopOpen = (localStorage.getItem('isShopOpenGlobal') === 'true');
            } else {
                // If NOT owner, default to false (closed), and let the owner's session dictate the status.
                // NOTE: This relies on the owner being the only one toggling, and customers always defaulting to 'closed'
                // unless the owner's session is active.
                isShopOpen = false;
            }

            // 3. Load Per-Item Sold Out Status
            loadItemSoldOutStatus();
            
            // 4. Update UI
            updateShopUI();
            renderMenu();
        }

        /**
         * Toggles the shop's open/closed status.
         * FIX: Writes to localStorage ONLY when in Owner Mode.
         */
        function toggleShopStatus() {
            isShopOpen = !isShopOpen;
            
            // Only the owner's session needs to store the global status
            if (isOwnerMode) {
                localStorage.setItem('isShopOpenGlobal', isShopOpen ? 'true' : 'false');
            }
            
            updateShopUI();
            renderMenu(); // Re-render menu to enable/disable buttons
        }
        
        /**
         * Updates all UI elements (status text, dimmer, button) based on the current shop status.
         */
        function updateShopUI() {
            const statusDisplay = document.getElementById('shop-status-display');
            const adminToggleText = document.getElementById('admin-status-text');
            const orderContent = document.getElementById('order-content');
            
            if (isShopOpen) {
                // OPEN state
                statusDisplay.textContent = "NOW OPEN";
                statusDisplay.className = "mt-2 text-xl font-black rounded-sm tracking-wider text-logo-green";
                adminToggleText.textContent = "OPEN";
                orderContent.classList.remove('shop-closed');
            } else {
                // CLOSED state
                statusDisplay.textContent = "CLOSED";
                statusDisplay.className = "mt-2 text-xl font-black rounded-sm tracking-wider text-red-600";
                adminToggleText.textContent = "CLOSED";
                orderContent.classList.add('shop-closed');
                // Reset quantities in memory when closed to ensure a fresh order next time
                menu.forEach(item => orderQuantities[item.id] = 0); 
            }
            
            updateSummary();
        }

        // --- CORE FUNCTIONS ---

        /**
         * Renders the menu items to the container.
         */
        function renderMenu() {
            const container = document.getElementById('menu-container');
            container.innerHTML = menu.map(item => {
                const isItemSoldOut = itemSoldOutStatus[item.id] || false;
                // Item is disabled if sold out OR if the entire shop is closed
                const isDisabled = isItemSoldOut || !isShopOpen; 
                
                const soldOutClass = isItemSoldOut ? 'sold-out' : ''; 
                
                // Reset quantity to 0 if the item is sold out or if the shop is closed
                if (isDisabled) {
                    orderQuantities[item.id] = 0;
                }

                // Owner toggle button HTML
                // ADDED: relative z-20 to ensure clickability over the z-10 sold out overlay
                const ownerToggle = isOwnerMode ? `
                    <button class="relative z-20 ml-4 p-1 text-xs font-semibold rounded-sm transition-colors duration-150 border-2 ${isItemSoldOut ? 'bg-red-600 text-white border-red-800' : 'bg-logo-green text-logo-purple border-logo-purple'}"
                        onclick="event.stopPropagation(); toggleItemSoldOut(${item.id})">
                        ${isItemSoldOut ? 'RE-STOCK' : 'SOLD OUT'}
                    </button>
                ` : '';


                return `
                    <div class="flex items-start p-3 bg-card-bg border-2 border-text-dark relative">
                        
                        <!-- Sold Out Overlay Text (if applicable) -->
                        ${isItemSoldOut ? 
                            '<div class="absolute inset-0 flex items-center justify-center text-2xl font-black text-white bg-red-600/80 tracking-widest z-10">SOLD OUT</div>' 
                            : ''
                        }
                        
                        <!-- Item content container (uses the sold-out class for visual dimming/pointer-events) -->
                        <div class="flex flex-grow ${soldOutClass} relative">
                            <!-- Image -->
                            <img src="${item.imageUrl}" 
                                 onerror="this.onerror=null;this.src='https://placehold.co/80x80/2F2E2A/4CAF50?text=üçµ'"
                                 alt="${item.name}" 
                                 class="w-20 h-20 object-cover rounded-none mr-4 flex-shrink-0 border-2 border-text-dark">

                            <!-- Text Details and Quantity Controls Container -->
                            <div class="flex-grow min-w-0 flex flex-col justify-between">
                                
                                <!-- Details -->
                                <div class="mb-2">
                                    <h3 class="text-lg font-semibold text-text-dark">${item.name}</h3>
                                    <p class="text-sm text-gray-700">${item.desc}</p>
                                </div>

                                <!-- Price and Quantity Controls -->
                                <div class="flex justify-between items-center mt-1">
                                    <p class="text-xl font-bold text-matcha-highlight">RM ${item.price.toFixed(2)}</p>
                                    
                                    <!-- OWNER TOGGLE BUTTON -->
                                    ${ownerToggle}
                                    
                                    <!-- Quantity Controls (Disabled if sold out or shop closed) -->
                                    <div class="flex items-center space-x-1 ml-auto">
                                        <button class="quantity-btn" 
                                                onclick="updateQuantity(${item.id}, -1)"
                                                ${isDisabled ? 'disabled' : ''}>
                                            &minus;
                                        </button>
                                        
                                        <input type="number" 
                                                id="qty-${item.id}" 
                                                value="${orderQuantities[item.id] || 0}" 
                                                min="0" 
                                                readonly 
                                                class="quantity-input">
                                                
                                        <button class="quantity-btn" 
                                                onclick="updateQuantity(${item.id}, 1)"
                                                ${isDisabled ? 'disabled' : ''}>
                                            &plus;
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Updates the quantity of a specific item.
         */
        function updateQuantity(itemId, change) {
            // Safety check for shop status and sold-out status
            const isItemSoldOut = itemSoldOutStatus[itemId] || false;
            if (!isShopOpen || isItemSoldOut) return;
            
            let currentQty = orderQuantities[itemId] || 0;
            let newQty = currentQty + change;
            
            if (newQty < 0) {
                newQty = 0;
            }
            
            orderQuantities[itemId] = newQty;
            document.getElementById(`qty-${itemId}`).value = newQty;
            
            updateSummary();
        }

        /**
         * Calculates the total cost and updates the UI and button state.
         */
        function updateSummary() {
            let totalCost = 0;
            let totalItems = 0; 

            menu.forEach(item => {
                const qty = orderQuantities[item.id] || 0;
                const isItemSoldOut = itemSoldOutStatus[item.id] || false;
                
                // Only count non-sold-out items for cost
                if (!isItemSoldOut) {
                    totalCost += qty * item.price;
                    totalItems += qty;
                }
            });

            // Update the display with total price
            document.getElementById('total-price').textContent = `RM ${totalCost.toFixed(2)}`;

            // Enable/disable the confirm button
            const confirmBtn = document.getElementById('confirm-button');
            // Button is disabled if no items selected OR if shop is closed
            confirmBtn.disabled = totalItems === 0 || !isShopOpen; 
        }

        /**
         * Generates the order message and redirects to WhatsApp.
         */
        function confirmOrder() {
            if (!isShopOpen) return; // Final check before sending

            // Check for WhatsApp number configuration
            if (WHATSAPP_NUMBER === "60123456789") {
                document.getElementById('whatsapp-message').classList.remove('hidden');
                console.error("Please update the WHATSAPP_NUMBER in the script before deploying.");
                return;
            }
            
            // Get user input
            const customerName = document.getElementById('customer-name').value.trim();
            const orderNotes = document.getElementById('order-notes').value.trim();
            
            // Enforce name input
            if (!customerName) {
                document.getElementById('confirm-button').classList.add('animate-pulse');
                setTimeout(() => document.getElementById('confirm-button').classList.remove('animate-pulse'), 1000);
                document.getElementById('customer-name').focus(); 
                return;
            }

            const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            
            const orderedItems = [];
            let totalCost = 0;
            
            menu.forEach(item => {
                const isItemSoldOut = itemSoldOutStatus[item.id] || false;
                if (isItemSoldOut) return; 

                const qty = orderQuantities[item.id];
                if (qty > 0) {
                    const lineTotal = qty * item.price;
                    orderedItems.push({
                        name: item.name,
                        qty: qty,
                        price: item.price,
                        total: lineTotal
                    });
                    totalCost += lineTotal;
                }
            });

            if (orderedItems.length === 0) {
                console.error("No items selected.");
                return;
            }

            // 2. Construct the message string
            let message = `‚ò¢Ô∏è NEW ORDER (${timestamp}) from Goji Cha! ‚ò¢Ô∏è\n`;
            message += `CUSTOMER: ${customerName}\n`;
            message += `PICKUP: Level 17 \n\n`; 
            message += "--- Customer Order ---\n";
            
            orderedItems.forEach(item => {
                message += `${item.qty}x ${item.name} (RM ${(item.qty * item.price).toFixed(2)})\n`;
            });
            
            message += `---------------------------\n`;
            message += `Total Due: RM ${totalCost.toFixed(2)}\n\n`;

            // Add notes if present
            if (orderNotes) {
                message += `*** SPECIAL NOTES: ***\n`;
                message += `${orderNotes}\n\n`;
            }
            
            message += "Hi Goji Cha! Please confirm the availability and my pickup time.";
            
            console.log("Generated Message:", message);
            
            // 3. Encode the message and build the URL
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
            
            // 4. Open WhatsApp
            window.open(whatsappUrl, '_blank');
        }

        // --- INITIALIZATION ---
        window.onload = initializeShopStatus;

    </script>
</body>
</html>
