<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GojiCha - Unleash Your Inner Kaiju</title>
    
    <!-- PWA MANIFEST LINK (Required for Add to Home Screen/PWA icon) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Specific Meta Tags (For Add to Home Screen function) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GojiCha Order">
    
    <!-- iOS Icons (Used when adding to home screen) -->
    <!-- NOTE: You should provide physical files named gojicha-192.png and gojicha-180.png in the root directory -->
    <link rel="apple-touch-icon" href="gojicha-192.png"> 
    <link rel="apple-touch-icon" sizes="180x180" href="gojicha-180.png"> 

    <!-- Theme Color for Browser/OS integration -->
    <meta name="theme-color" content="#892F7F">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configure Tailwind for the Gojira/Retro theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // NEW LOGO COLORS
                        'app-bg': '#E7F2E2',
                        'logo-gray': '#798799', 
                        'logo-purple': '#892F7F', 
                        'logo-green': '#81EE4A', 
                        
                        // Mapped old colors to new ones
                        'text-dark': '#892F7F',      
                        'card-bg': '#F7F4EB',        
                        'button-main': '#798799',    
                        'matcha-highlight': '#85c047',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styles */
        body {
            background-color: #E7F2E2;
        }
        .item-button {
            /* Blocky, high-contrast style for primary actions */
            @apply py-3 px-6 text-white font-bold rounded-none border-2 border-text-dark transition-all duration-200 shadow-[2px_2px_0_#892F7F] bg-logo-purple hover:bg-logo-green hover:text-text-dark hover:shadow-[3px_3px_0_#892F7F];
        }
        /* Custom style for the ice limit warning */
        .ice-warning {
            @apply text-sm font-extrabold text-red-700 bg-red-100 border border-red-700 p-2 mt-2 rounded-sm uppercase;
        }
        /* Style for sold out items */
        .sold-out {
            /* Applies visual dimming and is used with the main content dimmer below */
            @apply opacity-50;
        }
        /* Style for closed shop state (main content dimmer) */
        .shop-closed {
            opacity: 0.6; 
            pointer-events: none; /* Prevents interaction when closed */
        }
        /* Modal Backdrop */
        .app-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        /* Scrollable Modal Body */
        .modal-body {
            max-height: 80vh;
            overflow-y: auto;
        }
        /* FIX: Custom class for manually selected radio button state */
        .radio-visual.is-selected {
            background-color: #892F7F; /* logo-purple */
            color: white;
            border-color: #892F7F; /* logo-purple */
        }
        /* Custom button style for the Cancel button in the modal (Secondary style) */
        #cancel-customization-btn {
            /* Base item button reset + secondary style */
            @apply bg-card-bg text-text-dark border-logo-gray shadow-[2px_2px_0_#798799] hover:bg-gray-100 hover:text-text-dark hover:shadow-[3px_3px_0_#798799];
        }
    </style>
</head>
<body class="bg-logo-gray min-h-screen p-4 font-sans flex justify-center text-text-dark">
    
    <!-- SHOP CLOSED MODAL -->
    <div id="shop-closed-modal" class="app-modal hidden">
        <div class="bg-card-bg p-8 border-4 border-red-700 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <p class="text-6xl mb-4">üö´</p>
            <h2 class="text-3xl font-extrabold text-red-700 mb-2 uppercase">WE'RE CLOSED</h2>
            <p class="text-lg text-text-dark mb-6">
        Sorry,we are closed for today.
                <!-- We are currently outside of our operating hours.
            </p>
            <p class="text-sm text-gray-700 mb-6">
                Please check back later or during our usual window: <span class="font-bold">12.30 PM ‚Äì 2 PM (Lunch Hour)</span>. -->
            </p></br>
            <button onclick="hideShopClosedModal()"
                    class="py-3 px-6 bg-logo-gray text-white font-bold rounded-none border-2 border-text-dark hover:bg-text-dark transition-colors">
                Got It
            </button>
        </div>
    </div>
    <!-- END SHOP CLOSED MODAL -->

    <!-- CUSTOMIZATION MODAL -->
    <div id="customization-modal" class="app-modal hidden">
        <div class="bg-card-bg p-6 border-4 border-text-dark rounded-lg shadow-2xl w-full max-w-sm modal-body">
            <h2 id="modal-item-name" class="text-2xl font-bold text-text-dark mb-2 text-center"></h2>
            <p id="modal-item-desc" class="text-gray-700 text-center mb-4"></p>
            <input type="hidden" id="modal-item-id">

            <div class="space-y-6">
                
                <!-- Sweetness Option -->
                <div>
                    <label class="block text-xl font-bold mb-3 text-text-dark">üçØ Sweetness</label>
                    <div id="sweetness-options" class="grid grid-cols-3 gap-2">
                        <!-- Options injected here -->
                    </div>
                </div>

                <!-- Ice Level Option -->
                <div>
                    <label class="block text-xl font-bold mb-3 text-text-dark">üßä Ice Level</label>
                    <div id="ice-options" class="grid grid-cols-3 gap-2">
                        <!-- Options injected here -->
                    </div>
                </div>
                
                <!-- Add-Ons Option -->
                <div id="addons-section">
                    <label class="block text-xl font-bold mb-3 text-text-dark">‚ú® Add-ons</label>
                    <div id="addons-options" class="space-y-2">
                        <!-- Options injected here based on item type -->
                    </div>
                </div>

                <!-- Customized Price Display -->
                <div class="flex justify-between items-center text-xl font-bold border-t border-gray-300 pt-4">
                    <span>Item Price:</span>
                    <span id="customized-price">RM 0.00</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex space-x-4">
                <button onclick="closeCustomizationModal()" 
                        id="cancel-customization-btn"
                        class="w-1/3 py-3 font-bold rounded-none border-2 item-button">
                    Cancel
                </button>
                <button onclick="applyCustomization()"
                        id="add-to-cart-btn"
                        class="w-2/3 item-button">
                    Add
                </button>
            </div>
        </div>
    </div>
    <!-- END CUSTOMIZATION MODAL -->

    <div class="w-full max-w-lg bg-card-bg shadow-2xl border-4 border-text-dark rounded-lg overflow-hidden">
        
        <!-- Header - Themed with Poster Art -->
        <header class="h-40 relative bg-cover bg-center border-b-4 border-text-dark" 
                style="background-image: url('501873.png'); background-position: top center;">
            <div class="absolute inset-0 bg-text-dark opacity-0"></div>
            <div class="absolute inset-0"></div>
        </header>

        <div class="p-6 md:p-8">
            
            <!-- Information Banner: BSN Staff Only -->
            <div class="text-center p-3 mb-4 border-4 border-logo-purple bg-logo-green text-logo-purple font-extrabold text-lg rounded-none shadow-md">
                FOR WISMA BSN ONLY
            </div>

            <!-- Full Shop Introduction -->
            <div class="text-center text-base mb-6 border-b border-gray-300 pb-4">
                <h2 class="text-xl font-bold text-text-dark mb-2">Welcome to GojiCha!</h2>
                
                <p class="text-gray-700 mb-2">
                    Order your favorite drinks here 
                </p>
                <p class="font-extrabold text-text-dark mt-3">
                    Freshly brew and ready for you!
                    <span class="block text-sm text-gray-700 mt-1">üïò Open daily: 12.30 PM ‚Äì 2 PM</span>
                </p>
                <!-- Shop Status Display (Customer Facing) -->
                <div id="shop-status-display" class="mt-2 text-xl font-black rounded-sm tracking-wider"></div>
                
                <!-- Ice Limit Disclaimer -->
                <p id="ice-limit-disclaimer" class="ice-warning hidden">
                    ‚ö†Ô∏è DUE TO THE LIMITATION OF ICE, GOJICHA CAN ONLY BREW 15 CUPS A DAY. ‚ö†Ô∏è
                </p>
            </div>
            

            <!-- Admin Guide - Replaces toggles, visible only to owner -->
            <div id="admin-controls" class="text-center mb-6 hidden">
                <div class="p-3 bg-logo-gray text-white text-sm rounded-none">
                    ‚ö†Ô∏è **ADMIN MODE:** TO CHANGE THE SHOP STATUS OR SOLD-OUT ITEMS, YOU MUST **EDIT THE `GLOBAL_SHOP_STATUS` VARIABLE DIRECTLY IN THE `INDEX.HTML` FILE ON GITHUB** AND COMMIT THE CHANGES.
                </div>
            </div>

            <!-- Content Wrapper - Dimmed and disabled when shop is closed -->
            <div id="order-content" class="transition-opacity duration-300">
                <!-- Menu Section -->
                <main id="menu-container" class="space-y-4 mb-6">
                    <!-- Menu items will be injected here by JavaScript -->
                </main>
                
                <!-- Cart Summary Section -->
                <div class="border-t-4 border-text-dark pt-6 mt-8">
                    <h2 class="text-2xl font-bold text-text-dark mb-4">üõí Your Cart</h2>
                    <div id="cart-summary" class="space-y-3 mb-6 min-h-[50px]">
                        <!-- Cart items will be rendered here -->
                        <p class="text-gray-600 text-center py-4 border border-dashed rounded-sm">Cart is empty. Add a customized drink above!</p>
                    </div>
                </div>
                
                <!-- Customer Name Input -->
                <div class="mb-6">
                    <label for="customer-name" class="block text-xl font-bold mb-2 text-text-dark">üë§ Your Name</label>
                    <input type="text" id="customer-name"
                           class="w-full p-3 bg-card-bg border-2 border-text-dark rounded-none focus:ring-matcha-highlight focus:border-matcha-highlight"
                           placeholder="Enter your name for pickup" required>
                </div>
                <!-- End Customer Name Input -->

                <!-- Notes Input Section -->
                <div class="mb-8">
                    <label for="order-notes" class="block text-xl font-bold mb-2 text-text-dark">üìù Add Notes</label>
                    <p class="text-sm text-gray-700 mb-2">E.g., "Less ice" or "I'll be there in 5 mins."</p>
                    <textarea id="order-notes"
                              class="w-full p-3 h-20 bg-card-bg border-2 border-text-dark rounded-none focus:ring-matcha-highlight focus:border-matcha-highlight resize-none"
                              placeholder="Enter specific instructions here..."></textarea>
                </div>
                <!-- End Notes Input -->

                <!-- Order Summary & Confirmation Button -->
                <div class="border-t-4 border-text-dark pt-6">
                    
                    <!-- Pickup Info -->
                    <div class="text-center p-3 mb-4 border-4 border-logo-purple bg-logo-green text-logo-purple font-extrabold text-lg rounded-none shadow-md">
                        <span>üìç Pickup Location:</span>
                        <span class="text-text-dark font-extrabold">LEVEL 17</span>
                    </div>

                    <!-- Total Price -->
                    <div class="flex justify-between items-center text-xl font-bold text-text-dark mb-4">
                        <span>Total Price:</span>
                        <span id="total-price">RM 0.00</span>
                    </div>

                    <button onclick="confirmOrder()"
                        id="confirm-button"
                        disabled
                        class="w-full py-4 text-white font-bold rounded-none border-2 border-text-dark transition-all duration-200 shadow-[4px_4px_0_#2F2E2A]
                               bg-button-main hover:bg-matcha-highlight hover:shadow-[4px_4px_0_#4CAF50] disabled:bg-gray-400 disabled:shadow-[4px_4px_0_#9CA3AF]">
                        Confirm Order
                    </button>
                    
                    <p id="whatsapp-message" class="text-center text-sm text-button-main font-semibold mt-2 hidden">
                        ERROR: Please set the WhatsApp number in the script before deploying.
                    </p>
                </div>
            </div>
            <!-- End Content Wrapper -->
        </div>
        
    </div>

    <script>
        // --- CONFIGURATION ---
        const WHATSAPP_NUMBER = "60126915105"; 
        
        // =========================================================================
        // MANUAL SHOP STATUS CONTROL (Edit these variables on GitHub to change status)
        // =========================================================================
        
        const GLOBAL_SHOP_STATUS = {
            // Set to true to open the shop, false to close it.
            //isShopOpen: true,
              isShopOpen: false,
            
            // Set the status for each item ID below: true = SOLD OUT, false = IN STOCK
            itemSoldOutStatus: {
                1: false, // Matcha Latte
                2: false, // Strawberry Matcha
                3: false, // Earl Grey Matcha
                4: false, // Lemonade Matcha
                
                // FIZZ ITEMS
                5: false, // Strawberry Fizz
                6: false, // Lemonade Fizz

                // --- NEW COFFEE ITEMS ---
                7: false, // Americano
                8: false, // Latte
                9: false, // Caramel Latte
                10: false, // Spanish Latte
            }
        };
        
        // =========================================================================
        // END MANUAL SHOP STATUS CONTROL
        // =========================================================================

        // Global State 
        let isShopOpen = GLOBAL_SHOP_STATUS.isShopOpen;
        let itemSoldOutStatus = GLOBAL_SHOP_STATUS.itemSoldOutStatus; 
        
        // NEW STATE: Array of customized items in the cart
        let cartItems = []; 
        let currentCustomizationBasePrice = 0; // Temp price storage for modal calculations

        // Define customization options with display names and values
        const CUSTOMIZATION_OPTIONS = {
            sweetness: [
                { display: 'Normal', value: 'Normal Sugar' },
                { display: 'Less', value: 'Less Sugar' },
                { display: 'None', value: 'No Sugar' },
            ],
            ice: [
                { display: 'Normal', value: 'Normal' },
                { display: 'Less', value: 'Less' },
                { display: 'Hot', value: 'Hot' }, // Full list includes 'Hot'
            ],
            // Defined type-specific add-ons
            addons: {
                
                coffee: [
                    { display: 'Extra Shot', value: 'Extra Shot', price: 2.50 },
                ]
               
            }
        };

        // Define your menu items
        const menu = [
            // Existing Matcha items (type: matcha)
            { id: 1, name: "Matcha Latte", price: 10.00, desc: "Classic iced pure matcha, sweetened/unsweetened, & Oatside milk.", imageUrl: "800x800latte.png", type: 'matcha' },
            { id: 2, name: "Strawberry Matcha", price: 13.00, desc: "Sweet strawberry puree layered with cool matcha & Oatside milk.", imageUrl: "800x800straw.png", type: 'matcha' },
            { id: 3, name: "Earl Grey Matcha", price: 11.00, desc: "Creamy matcha layered with Earl Grey syrup & Oatside milk.", imageUrl: "800x800earl.png", type: 'matcha' },
            { id: 4, name: "Lemonade Matcha", price: 12.00, desc: "Tangy fresh sparkling lemonade topped with vibrant matcha.", imageUrl: "800x800lemon.png", type: 'matcha' },

            // NEW FIZZ ITEMS (type: fizz)
            { id: 5, name: "Strawberry Fizz", price: 9.00, desc: "A bubbly blend of sweet strawberry puree and sparkling water, topped with a crisp splash of lime.", imageUrl: "fizz_strawberry.png", type: 'fizz' },
            { id: 6, name: "Lemonade Fizz", price: 9.00, desc: "Our classic tangy lemonade energized with carbonation for a zesty, sharp, and effervescent cooler.", imageUrl: "fizz_lemonade.png", type: 'fizz' },

            // --- NEW COFFEE ITEMS (type: coffee) ---
            { id: 7, name: "Americano", price: 9.00, desc: "Bold espresso diluted with hot water, served over ice.", imageUrl: "coffee_americano.png", type: 'coffee' },
            { id: 8, name: "Latte", price: 10.00, desc: "Espresso with creamy steamed milk", imageUrl: "coffee_latte.png", type: 'coffee' },
            { id: 9, name: "Caramel Latte", price: 11.00, desc: "Sweet latte infused with rich caramel syrup.", imageUrl: "coffee_latte_caramel.png", type: 'coffee' },
            { id: 10, name: "Spanish Latte", price: 11.00, desc: "Rich espresso mixed with condensed milk and regular milk.", imageUrl: "coffee_latte_spanish.png", type: 'coffee' },
        ];
        
        // --- UTILITY FUNCTIONS ---
        
        // Generates a simple unique ID for cart items
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // --- MODAL CONTROL ---

        function showShopClosedModal() {
            document.getElementById('shop-closed-modal').classList.remove('hidden');
        }

        window.hideShopClosedModal = function() {
            document.getElementById('shop-closed-modal').classList.add('hidden');
        }

        /**
         * Manually handles the visual selection state for radio buttons.
         */
        window.handleRadioSelection = function(clickedLabel, groupName) {
            // 1. Unselect all visuals in this group
            document.querySelectorAll(`[data-group="${groupName}"] .radio-visual`).forEach(span => {
                span.classList.remove('is-selected');
            });

            // 2. Select the visual for the clicked item
            const visualSpan = clickedLabel.querySelector('.radio-visual');
            const radioInput = clickedLabel.querySelector('input[type="radio"]');
            
            if (visualSpan && radioInput) {
                visualSpan.classList.add('is-selected');
                // Ensure the hidden input is checked and trigger price update
                radioInput.checked = true; 
                updateCustomizedPrice();
            }
        }


        // --- CUSTOMIZATION LOGIC ---

        /**
         * Renders customization options into the modal.
         */
        function renderCustomizationRadios(type, options, containerId, defaultValue) {
            const container = document.getElementById(containerId);
            
            // Determine the actual default value. If the provided defaultValue is not in options, use the first one.
            const defaultExists = options.some(opt => opt.value === defaultValue);
            const finalDefaultValue = defaultExists ? defaultValue : options[0]?.value;

            container.innerHTML = options.map(option => `
                <!-- FIX: Added data-group for JS selection management -->
                <label class="block cursor-pointer radio-option" data-group="${type}" onclick="handleRadioSelection(this, '${type}')">
                    <input type="radio" name="${type}" value="${option.value}" class="hidden" 
                        ${option.value === finalDefaultValue ? 'checked' : ''}
                        data-price="${option.price || 0}">
                    <!-- FIX: Removed inline 'checked:' classes to avoid conflict -->
                    <span class="radio-visual block text-center p-2 text-sm border-2 border-text-dark rounded-none bg-card-bg text-text-dark transition-colors 
                                 hover:bg-logo-green hover:text-logo-purple">
                        ${option.display} 
                        ${option.price ? `(+RM ${option.price.toFixed(2)})` : ''}
                    </span>
                </label>
            `).join('');
            
            // Initial selection styling based on default value
            container.querySelector(`input[name="${type}"][value="${finalDefaultValue}"]`)?.nextElementSibling.classList.add('is-selected');
            
            // Also attach price calculation to the inputs, although the handler calls it too
            container.querySelectorAll(`input[name="${type}"]`).forEach(input => {
                input.onchange = updateCustomizedPrice; 
            });
        }

        /**
         * Renders addon checkboxes.
         */
        function renderAddons(options) {
            const container = document.getElementById('addons-options');
            container.innerHTML = options.map(addon => `
                <label class="flex items-center space-x-2 p-2 border-2 border-text-dark bg-card-bg cursor-pointer transition-colors hover:bg-gray-100">
                    <input type="checkbox" name="addon" value="${addon.value}" 
                           data-price="${addon.price.toFixed(2)}" 
                           onchange="updateCustomizedPrice()" 
                           class="form-checkbox text-logo-purple h-5 w-5 border-text-dark focus:ring-logo-purple rounded-none">
                    <span class="text-text-dark flex-grow">${addon.display}</span>
                    <span class="text-logo-green font-bold text-base">+RM ${addon.price.toFixed(2)}</span>
                </label>
            `).join('');
        }

        /**
         * Updates the price display in the modal based on selected options.
         */
        function updateCustomizedPrice() {
            let runningTotal = currentCustomizationBasePrice;

            // Add-ons calculation
            document.querySelectorAll('#addons-options input[name="addon"]:checked').forEach(checkbox => {
                runningTotal += parseFloat(checkbox.dataset.price);
            });

            document.getElementById('customized-price').textContent = `RM ${runningTotal.toFixed(2)}`;
        }


        /**
         * Opens the modal for customizing a specific item.
         */
        window.openCustomizationModal = function(itemId) {
            const item = menu.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('modal-item-name').textContent = item.name;
            document.getElementById('modal-item-desc').textContent = item.desc;
            document.getElementById('modal-item-id').value = item.id;
            
            currentCustomizationBasePrice = item.price;
            
            // --- DYNAMIC SWEETNESS OPTIONS LOGIC ---
            // IDs of drinks that CANNOT have the 'No Sugar' option
            const NO_SUGAR_RESTRICTED_IDS = [2, 3, 4, 5, 6, 9, 10]; 
            let sweetnessOptions = CUSTOMIZATION_OPTIONS.sweetness;
            
            // Filter out 'No Sugar' option if the item ID is restricted
            if (NO_SUGAR_RESTRICTED_IDS.includes(item.id)) {
                sweetnessOptions = sweetnessOptions.filter(option => option.value !== 'No Sugar');
            }
            // --- END DYNAMIC SWEETNESS OPTIONS ---


            // --- DYNAMIC ICE OPTIONS LOGIC ---
            let iceOptions = CUSTOMIZATION_OPTIONS.ice;
            
            // IDs of drinks that CAN have the HOT option: 1 (Matcha Latte), 3 (Earl Grey Matcha), 7, 8, 9, 10 (Coffee)
            const HOT_OPTION_INCLUSION_IDS = [1, 3, 7, 8, 9, 10]; 

            // If the item is NOT in the inclusion list, remove the 'Hot' option.
            if (!HOT_OPTION_INCLUSION_IDS.includes(item.id)) {
                iceOptions = iceOptions.filter(option => option.value !== 'Hot');
            }
            // --- END DYNAMIC ICE OPTIONS ---

            // Render Sweetness using the potentially filtered list
            renderCustomizationRadios('sweetness', sweetnessOptions, 'sweetness-options', 'Normal Sugar');
            
            // Render filtered Ice options
            renderCustomizationRadios('ice', iceOptions, 'ice-options', 'Normal');
            
            // Render type-specific Add-ons based on item.type
            const addonsForType = CUSTOMIZATION_OPTIONS.addons[item.type] || [];
            const addonsSection = document.getElementById('addons-section');

            if (addonsForType.length > 0) {
                renderAddons(addonsForType);
                addonsSection.classList.remove('hidden');
            } else {
                // Hide add-ons section if none are available for this type
                addonsSection.classList.add('hidden');
                document.getElementById('addons-options').innerHTML = '';
            }

            // Initial price update
            updateCustomizedPrice(); 

            document.getElementById('customization-modal').classList.remove('hidden');
        }

        /**
         * Closes the modal.
         */
        function closeCustomizationModal() {
            document.getElementById('customization-modal').classList.add('hidden');
        }

        /**
         * Takes customization from modal and adds a new, unique item to the cart.
         */
        function applyCustomization() {
            const itemId = parseInt(document.getElementById('modal-item-id').value);
            const item = menu.find(i => i.id === itemId);
            
            if (!item) return;

            // Gather customization details
            const sweetness = document.querySelector('input[name="sweetness"]:checked')?.value || 'Normal Sugar';
            const ice = document.querySelector('input[name="ice"]:checked')?.value || 'Normal';
            
            const selectedAddons = [];
            let addonsCost = 0;
            
            // Note: This query still works because only relevant checkboxes are rendered
            document.querySelectorAll('#addons-options input[name="addon"]:checked').forEach(checkbox => {
                selectedAddons.push(checkbox.value);
                addonsCost += parseFloat(checkbox.dataset.price);
            });

            const totalPrice = item.price + addonsCost;

            // Create unique cart item object
            const newCartItem = {
                cartId: generateUniqueId(),
                itemId: item.id,
                name: item.name,
                basePrice: item.price,
                totalPrice: totalPrice,
                customizations: {
                    sweetness: sweetness,
                    ice: ice,
                    addons: selectedAddons
                }
            };

            cartItems.push(newCartItem);
            closeCustomizationModal();
            renderCartSummary();
        }

        /**
         * Removes an item from the cart by its unique cartId.
         */
        window.removeCartItem = function(cartId) {
            cartItems = cartItems.filter(item => item.cartId !== cartId);
            renderCartSummary();
        }

        // --- SHOP STATUS LOGIC (Simplified) ---
        
        /**
         * Initializes shop status and checks for owner access.
         */
        function initializeApp() {
             // 1. Check for Owner Access Parameter (?owner=true)
            const urlParams = new URLSearchParams(window.location.search);
            const isOwnerMode = urlParams.get('owner') === 'true';
            
            if (isOwnerMode) {
                document.getElementById('admin-controls').classList.remove('hidden');
            }
            
            // 2. Update UI based on the static config
            updateShopUI();
            renderMenu(isOwnerMode); 
            renderCartSummary(); 
            
            // 3. Show closed modal ONCE on load if the shop is closed
            if (!isShopOpen) {
                showShopClosedModal();
            }

            // 4. PWA Manifest generation (Dynamically creates manifest for Add to Home Screen)
            const manifestData = {
                "name": "GojiCha Order",
                "short_name": "GojiCha",
                "description": "Mobile ordering system for GojiCha Pop-up.",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#E7F2E2",
                "theme_color": "#892F7F",
                "icons": [
                    {
                        "src": "gojicha-192.png",
                        "sizes": "192x192",
                        "type": "image/png"
                    },
                    {
                        "src": "gojicha-512.png",
                        "sizes": "512x512",
                        "type": "image/png"
                    }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.querySelector('link[rel="manifest"]').setAttribute('href', manifestUrl);
        }
        
        /**
         * Updates all UI elements (status text, dimmer, button) based on the current shop status.
         */
        function updateShopUI() {
            const statusDisplay = document.getElementById('shop-status-display');
            const orderContent = document.getElementById('order-content');
            const iceDisclaimer = document.getElementById('ice-limit-disclaimer');
            
            if (isShopOpen) {
                // OPEN state
                statusDisplay.textContent = "NOW OPEN";
                statusDisplay.className = "mt-2 text-xl font-black rounded-sm tracking-wider text-logo-green";
                orderContent.classList.remove('shop-closed');
                iceDisclaimer.classList.remove('hidden'); 
                hideShopClosedModal(); // Hide modal if shop opens
            } else {
                // CLOSED state
                statusDisplay.textContent = "SORRY! WE'RE CLOSED";
                statusDisplay.className = "mt-2 text-xl font-black rounded-sm tracking-wider text-red-600";
                orderContent.classList.add('shop-closed');
                iceDisclaimer.classList.add('hidden'); 
                
                // Reset cart and prevent new orders
                cartItems = []; 
            }
            
            // Must re-render menu to correctly enable/disable buttons
            renderMenu(document.getElementById('admin-controls').classList.contains('hidden') ? false : true);
            renderCartSummary();
        }

        // --- CORE FUNCTIONS ---

        /**
         * Renders the main menu, now applying disabled state to buttons when needed.
         */
        function renderMenu(isOwnerMode) {
            const container = document.getElementById('menu-container');
            container.innerHTML = menu.map(item => {
                const isItemSoldOut = itemSoldOutStatus[item.id] || false;
                // Determine disabled status based on global shop status AND item stock
                const isDisabled = isItemSoldOut || !isShopOpen; 
                const soldOutClass = isItemSoldOut ? 'sold-out' : ''; 
                
                // Owner status text display
                const ownerStatus = isOwnerMode ? `
                    <div class="relative z-20 ml-4 p-1 text-xs font-semibold rounded-sm transition-colors duration-150 border-2 ${isItemSoldOut ? 'bg-red-600 text-white border-red-800' : 'bg-logo-green text-logo-purple border-logo-purple'}">
                        ${isItemSoldOut ? 'SOLD OUT' : 'IN STOCK'}
                    </div>
                ` : '';


                return `
                    <div class="flex items-start p-3 bg-card-bg border-2 border-text-dark relative">
                        
                        <!-- Sold Out Overlay Text (if applicable) -->
                        ${isItemSoldOut ? 
                            '<div class="absolute inset-0 flex items-center justify-center text-2xl font-black text-white bg-red-600/80 tracking-widest z-10">SOLD OUT</div>' 
                            : ''
                        }
                        
                        <!-- Item content container -->
                        <div class="flex flex-grow ${soldOutClass} relative">
                            <!-- Image -->
                            <img src="${item.imageUrl}" 
                                 onerror="this.onerror=null;this.src='https://placehold.co/80x80/2F2E2A/4CAF50?text=üçµ'"
                                 alt="${item.name}" 
                                 class="w-20 h-20 object-cover rounded-none mr-4 flex-shrink-0 border-2 border-text-dark">

                            <!-- Text Details and Button Container -->
                            <div class="flex-grow min-w-0 flex flex-col justify-between">
                                
                                <!-- Details -->
                                <div class="mb-2">
                                    <h3 class="text-lg font-semibold text-text-dark">${item.name}</h3>
                                    <p class="text-sm text-gray-700">${item.desc}</p>
                                </div>

                                <!-- Price and Action Controls -->
                                <div class="flex justify-between items-center mt-1">
                                    <p class="text-xl font-bold text-matcha-highlight">RM ${item.price.toFixed(2)}</p>
                                    
                                    <!-- OWNER STATUS DISPLAY -->
                                    ${ownerStatus}
                                    
                                    <!-- CUSTOMIZE & ADD BUTTON (Updated Text & respects isDisabled) -->
                                    <button onclick="openCustomizationModal(${item.id})"
                                            ${isDisabled ? 'disabled' : ''}
                                            class="ml-auto py-2 px-4 text-sm item-button disabled:bg-gray-400 disabled:shadow-[2px_2px_0_#9CA3AF]">
                                        Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Renders the current list of customized items in the cart summary.
         */
        function renderCartSummary() {
            const container = document.getElementById('cart-summary');
            let totalCost = 0;

            if (cartItems.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center py-4 border border-dashed rounded-sm">Cart is empty. Add a customized drink above!</p>';
            } else {
                container.innerHTML = cartItems.map((item) => {
                    totalCost += item.totalPrice;
                    
                    // Format customizations into an easy-to-read list
                    const customList = [
                        item.customizations.sweetness,
                        // Ensure 'Hot' is displayed without ' Ice' suffix
                        item.customizations.ice === 'Hot' ? item.customizations.ice : item.customizations.ice + ' Ice',
                        ...item.customizations.addons
                    ].join(' ‚Ä¢ ');

                    return `
                        <div class="flex justify-between items-center p-3 border-2 border-logo-gray bg-white rounded-none">
                            <div class="flex-grow min-w-0">
                                <p class="font-semibold text-text-dark">${item.name}</p>
                                <p class="text-xs text-gray-600 truncate">${customList}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-bold text-logo-purple">RM ${item.totalPrice.toFixed(2)}</span>
                                <button onclick="removeCartItem('${item.cartId}')" 
                                        class="p-1 text-sm text-white bg-red-600 rounded-sm hover:bg-red-700">
                                    &times;
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Update final total and button status
            document.getElementById('total-price').textContent = `RM ${totalCost.toFixed(2)}`;
            const confirmBtn = document.getElementById('confirm-button');
            confirmBtn.disabled = cartItems.length === 0 || !isShopOpen; 
        }

        /**
         * Generates the order message and redirects to WhatsApp.
         */
        function confirmOrder() {
            // Check if shop is open again (redundant if button is disabled, but safe)
            if (!isShopOpen || cartItems.length === 0) {
                // If shop is closed, show modal if it's not already visible.
                if (!isShopOpen) showShopClosedModal(); 
                return; 
            }

            if (WHATSAPP_NUMBER === "60123456789") {
                document.getElementById('whatsapp-message').classList.remove('hidden');
                console.error("Please update the WHATSAPP_NUMBER in the script before deploying.");
                return;
            }
            
            const customerName = document.getElementById('customer-name').value.trim();
            const orderNotes = document.getElementById('order-notes').value.trim();
            
            if (!customerName) {
                document.getElementById('confirm-button').classList.add('animate-pulse');
                setTimeout(() => document.getElementById('confirm-button').classList.remove('animate-pulse'), 1000);
                document.getElementById('customer-name').focus(); 
                return;
            }

            // Capture full date and time
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                year: 'numeric', 
                month: 'numeric', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false 
            });
            
            let totalCost = 0;
            
            // 1. Start message construction
            let message = `‚ò¢Ô∏è NEW ORDER (${timestamp}) from GojiCha! ‚ò¢Ô∏è\n`;
            message += `CUSTOMER: ${customerName}\n`;
            message += `PICKUP: Level 17 \n\n`; 
            message += "--- Customer Order (Detailed) ---\n";
            
            // 2. Iterate through each item instance in the cart
            cartItems.forEach((item, index) => {
                totalCost += item.totalPrice; 
                
                // Construct customization details string for WhatsApp
                const customDetails = [];
                customDetails.push(`Sweetness: ${item.customizations.sweetness}`);
                
                // Handle 'Hot' display for WhatsApp
                const tempDisplay = item.customizations.ice === 'Hot' ? 'Hot' : `${item.customizations.ice} Ice`;
                customDetails.push(`Temperature: ${tempDisplay}`);

                if (item.customizations.addons.length > 0) {
                    customDetails.push(`Add-ons: ${item.customizations.addons.join(', ')}`);
                }
                
                message += `${index + 1}. ${item.name} (RM ${item.totalPrice.toFixed(2)})\n`;
                message += `   - ${customDetails.join('\n   - ')}\n`;
            });
            
            message += `---------------------------\n`;
            message += `TOTAL DUE: RM ${totalCost.toFixed(2)}\n\n`;

            if (orderNotes) {
                message += `*** SPECIAL NOTES: ***\n`;
                message += `${orderNotes}\n\n`;
            }
            
            message += "Hi GojiCha! Please confirm the availability and my pickup time.";
            
            console.log("Generated Message:", message);
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // --- INITIALIZATION ---
        window.onload = initializeApp;

    </script>
</body>
</html>
